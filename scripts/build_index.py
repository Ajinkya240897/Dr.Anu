<full build_index code from previous answer>